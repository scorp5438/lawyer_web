worker_processes auto;

events {
    worker_connections 1024;
    multi_accept on;
    use epoll;
}

http {
    include mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 30s;
    keepalive_requests 100;
    send_timeout 20s;

    server_tokens off;  # Скрывает версию Nginx (безопасность)

    # Кэширование для прокси
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;

    add_header X-Frame-Options "SAMEORIGIN" always; # Запрещаем встраивание в <iframe> (защита от кликджекинга)

    add_header X-Content-Type-Options "nosniff" always; # Блокируем MIME-sniffing (защита от XSS)

    # Включаем политику безопасности контента (CSP) - пример, подстройте под ваш проект
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' *.advocat-saprolex.ru; style-src 'self' 'unsafe-inline'; img-src 'self' data:;" always;

    # HSTS (заставляем браузеры использовать HTTPS)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Настройки буферов
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    client_max_body_size 20m;  # Максимальный размер загружаемого файла
    large_client_header_buffers 4 8k;

    # Кэширование файловых дескрипторов
    open_file_cache max=2000 inactive=20s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors off;

    # Gzip-сжатие
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_vary on;

    # Защита от DDOS (лимиты запросов)
    limit_req_zone $binary_remote_addr zone=one:10m rate=100r/s;

    # Формат логов с реальным IP (если есть прокси)
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';

    # Отдельный лог для ошибок
    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log main buffer=16k flush=5m;
    server{
	listen 80;
	server_name advocat-saprolex.ru www.advocat-saprolex.ru;
	return 301 https://$host$request_uri;
}
    server {
        listen 443 ssl;
        server_name advocat-saprolex.ru www.advocat-saprolex.ru;
	
	ssl_certificate /etc/letsencrypt/live/advocat-saprolex.ru/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/advocat-saprolex.ru/privkey.pem;

	# Доп. SSL-настройки (рекомендуется)
	# ssl_protocols TLSv1.2 TLSv1.3;
	# ssl_prefer_server_ciphers on;
	# ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256...';

        # Блокировка User-Agent
        if ($http_user_agent ~* (wget|curl|nikto|sqlmap|zgrab|python-requests)) {
            return 403;
        }

        # Запрет HTTP-методов, кроме нужных
        if ($request_method !~ ^(GET|HEAD|POST|PUT|PATCH|DELETE)$) {
            return 405;
        }

        # Статика Django Admin (должен быть ПЕРВЫМ!)
        location /static/admin/ {
            alias /app/static/admin/;
            expires 365d;
            access_log off;
            add_header Cache-Control "public, immutable";  # Добавляем 'immutable'
            add_header X-Content-Type-Options "nosniff";  # Защита от MIME-sniffing
            etag off;  # Отключаем ETag (используем только expires)
        }

        # Остальная статика Django
        location /static/ {
            alias /app/static/;
            expires 30d;
            access_log off;  # Добавляем отключение логов
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
        }

        # Медиа-файлы Django
        location /media/ {
            alias /media/;
            expires 30d;
            access_log off;
            add_header Cache-Control "public";
            add_header X-Content-Type-Options "nosniff";
        }

        # Статика React (если нужно)
        location ~* ^/static_react/(.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2))$ {
            root /usr/share/nginx/html;
            expires max;
            access_log off;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff";
            etag off;
            try_files $uri $uri\ =404;
        }

        # API и админка Django
        location ~ ^/(api|admin)/ {
            limit_req zone=one burst=5 nodelay;
            proxy_pass http://web:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_set_header X-Superuser-Access $http_x_superuser_access;
            proxy_set_header X-Get-Token-Csrf-For-React $http_x_get_token_csrf_for_react;

            # Оптимизация прокси
            proxy_buffer_size 32k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 128k;

            # Таймауты
            proxy_connect_timeout 15s;
            proxy_read_timeout 60s;
            proxy_send_timeout 30s;

			# Обработка ошибок бэкенда
		    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
		    proxy_next_upstream_tries 3;
		    proxy_next_upstream_timeout 10s;

		    # Кэширование ошибок
		    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
			
            # Заголовки безопасности
            add_header X-Frame-Options "SAMEORIGIN";
            add_header X-Content-Type-Options "nosniff";

        }

        # Главный SPA роут
        location / {
            limit_req zone=one burst=5 nodelay;
            root /usr/share/nginx/html/static_react;
            try_files $uri $uri/ /index.html;
            expires 0;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";

            # Заголовки безопасности
            add_header X-Frame-Options "SAMEORIGIN";
            add_header X-Content-Type-Options "nosniff";
            add_header Referrer-Policy "strict-origin-when-cross-origin";
        }
    }
}
